<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Screams of Oblivion</title>
  <link rel="stylesheet" href="mainlogged.css">
  <link href="https://fonts.googleapis.com/css2?family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="header-left">
      <div class="logo" aria-hidden="true"></div>
      <div class="nomepequeno">
        <h5>
          <span>Screams</span><br>
          <span>of</span><br>
          <span>Oblivion</span>
        </h5>
      </div>
    </div>
    <nav class="navegacaoheader">
      <a href="mainlogged.html" data-i18n="back">Back</a>
    </nav>
  </header>

  <main class="centered">
    <h2 data-i18n="settings">Settings</h2>
    <form id="settings-form">
      <label><span data-i18n="language">Language</span>
        <select id="settings-language">
          <option value="en">English</option>
          <option value="pt">Português</option>
        </select>
      </label>
      <label><span data-i18n="display_name">Display name</span>
        <input type="text" id="settings-name" placeholder="Apelido">
      </label>
      <label><span data-i18n="change_avatar">Change avatar</span>
        <input type="file" id="settings-avatar" accept="image/*">
      </label>
      <div class="settings-actions">
        <button type="button" id="delete-account" class="danger" data-i18n="delete_account">Delete account</button>
        <button type="submit" class="primary" data-i18n="save">Save</button>
      </div>
    </form>
  </main>

  <script src="api-client.js"></script>
  <script src="i18n.js"></script>
  <script>
    const settingsForm = document.getElementById('settings-form');
    const settingsAvatar = document.getElementById('settings-avatar');
    const settingsName = document.getElementById('settings-name');
    const settingsLanguage = document.getElementById('settings-language');
    let stagedAvatar = null;

    async function carregarConfigracoes() {
      if (!estaAutenticado()) {
        window.location.href = 'login.html';
        return;
      }

      try {
        const usuario = await obterUsuarioAtual();
        if (usuario) {
          settingsName.value = usuario.displayName || '';
          
          // Load user's saved language preference from server
          const langRes = await fetch('../api/get_language.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: usuario.id })
          });
          const langData = await langRes.json();
          if (langData.idioma) {
            settingsLanguage.value = langData.idioma;
            await i18n.loadLanguage(langData.idioma);
          }
        } else {
          window.location.href = 'login.html';
        }
      } catch (erro) {
        console.error('Erro ao carregar configurações:', erro);
        window.location.href = 'login.html';
      }
    }

    settingsLanguage.addEventListener('change', async (e) => {
      const novoIdioma = e.target.value;
      try {
        const usuario = await obterUsuarioAtual();
        if (usuario) {
          const res = await fetch('../api/set_language.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: usuario.id, idioma: novoIdioma })
          });
          const data = await res.json();
          if (data.sucesso) {
            await i18n.loadLanguage(novoIdioma);
            i18n.applyTranslations();
            console.log('Idioma alterado para:', novoIdioma);
          }
        }
      } catch (erro) {
        console.error('Erro ao salvar idioma:', erro);
      }
    });

    settingsAvatar.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => { stagedAvatar = reader.result; };
      reader.readAsDataURL(file);
    });

    settingsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nome_exibicao = settingsName.value.trim();
      const dados = {};
      
      if (nome_exibicao) dados.nome_exibicao = nome_exibicao;
      if (stagedAvatar) dados.avatar = stagedAvatar;

      try {
        await atualizarPerfil(dados);
        window.location.href = 'mainlogged.html';
      } catch (erro) {
        console.error('Erro ao atualizar perfil:', erro);
      }
    });

    document.getElementById('delete-account').addEventListener('click', () => {
      window.location.href = 'delete-confirm.html';
    });

    // Initialize i18n before loading settings
    (async () => {
      await i18n.initialize();
      i18n.applyTranslations();
      await carregarConfigracoes();
    })();
  </script>
</body>
</html>
